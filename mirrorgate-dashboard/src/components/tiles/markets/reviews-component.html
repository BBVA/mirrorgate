<!doctype html>
<!--
  ~ Copyright 2017 Banco Bilbao Vizcaya Argentaria, S.A.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!-- build:js component.min.js -->
<script src="model.js"></script>
<script src="controller.js"></script>
<!-- endbuild -->
<template>
    <style> @import "css/styles.css";</style>

    <div class="reviews component__content">
      <div class="component__header">
        <h2 class="title">Last Comment</h2>
      </div>
      <div class="component__body">
        <div id="container">
          <span><i aria-hidden="true" class="fa fa-apple"></i></span>
        </div>
      </div>
    </div>
</template>

<script>

  (function(window, document, undefined) {

    // Refers to the "importee", which is components/team-dashboard.html
    var thisDoc =  (document._currentScript || document.currentScript).ownerDocument;
    var tmpl = thisDoc.querySelector('template');

    // Creates an object based in the HTML Element prototype
    var MyElementProto = Object.create(Tile);

    MyElementProto.getControllerClass = function () {
      return MarketsController;
    };

    MyElementProto.getTemplate = function () {
      return tmpl;
    };

    MyElementProto.render = function (apps) {

      Utils.raiseEvent(this,{
          status: apps ? 'unknown':'server-error'
      });

      var marginTop = 10;

      var container = this.shadowRoot.querySelector('#container');
      container.innerHTML= '';

      if(!apps) {
        return;
      }

      var last_review_timestamp = -1;
      var lastAppReview = apps[0];

      for(var index in apps) {
        lastAppReview = apps[index].last_review_timestamp > last_review_timestamp ? apps[index] : lastAppReview;
        last_review_timestamp = lastAppReview.last_review_timestamp;
      }

      if(lastAppReview) {
        var reviewDiv = createReviewElement(lastAppReview)
        container.appendChild(reviewDiv);
      }
    }

    function createReviewElement(app) {

      var last_review = thisDoc.createElement('div');
      last_review.setAttribute('class', 'review');

      var appPlatformTextNode = thisDoc.createTextNode(app.platform);

      var platformIcon = thisDoc.createElement('i');
      platformIcon.setAttribute('aria-hidden', true);

      if(app.platform == "IOS"){
        platformIcon.setAttribute('class', 'fa fa-apple');
        var appPlatformTextNode = platformIcon;
      }
      else if(app.platform == "Android"){
        platformIcon.setAttribute('class', 'fa fa-android');
        var appPlatformTextNode = platformIcon;
      }

      //header
      var last_review_header_div = thisDoc.createElement('div');
      last_review_header_div.setAttribute('class', 'review__header');

      var last_review_date_div = thisDoc.createElement('div');
      last_review_date_div.setAttribute('class', 'review__date');
      var last_review_date = thisDoc.createTextNode(moment(new Date(app.last_review_timestamp)).format("lll"));

      var last_review_author = thisDoc.createTextNode(app.last_review_author);

      //Rate
      var last_review_rate_div = thisDoc.createElement('div');
      last_review_rate_div.setAttribute('class', 'review__rate');

      var last_review_rate = createStarRatingElement(+ app.last_review_rate);
      var last_review_comment = thisDoc.createTextNode(app.last_review_comment);

      //Comment
      var last_review_comment_div = thisDoc.createElement('div');
      last_review_comment_div.setAttribute('class', 'review__comment');

      //Construct
      last_review.appendChild(last_review_header_div);
      last_review_header_div.appendChild(last_review_date_div);
      last_review_date_div.appendChild(last_review_date);
      last_review_header_div.appendChild(last_review_author);

      last_review.appendChild(last_review_rate_div);
      last_review_rate_div.appendChild(appPlatformTextNode);
      last_review_rate_div.appendChild(last_review_rate);

      last_review.appendChild(last_review_comment_div);
      last_review_comment_div.appendChild(last_review_comment);

      return last_review;
    }

    function createStarRatingElement(rate) {
      var stars = thisDoc.createElement('span');
      stars.setAttribute("class", "rate");

      for(i = 0; i < 5; i++ ) {
        var star = thisDoc.createElement('i');
        star.setAttribute('aria-hidden', true);
        if(rate - i >= 1 ) {
          star.setAttribute('class', 'fa fa-star');
        } else if (rate - i > 0 ){
          star.setAttribute('class', 'fa fa-star-half-o')
        } else {
          star.setAttribute('class', 'fa fa-star-o')
        }
        stars.appendChild(star);
      }

      return stars;
    }

    // Registers <team-dashboard> in the main document
    window.MyElement = document.registerElement('reviews-tile', {
        prototype: MyElementProto
    });
  })(window, document);
</script>
